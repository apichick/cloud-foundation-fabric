# Copyright 2022 Google LLC
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#     http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- hosts: mgmt
  gather_facts: "no"
  vars_files:
    - vars/vars.yaml
  environment:
    USE_GKE_GCLOUD_AUTH_PLUGIN: True
  tasks:
    - name: Download the Google Cloud SDK package repository signing key
      get_url:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        dest: /usr/share/keyrings/cloud.google.gpg
        force: yes
      become: true
      become_user: root
    - name: Add Google Cloud SDK package repository source
      apt_repository:
        filename: google-cloud-sdk
        repo: "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main"
        state: present
        update_cache: yes
      become: true
      become_user: root  
    - name: Install dependencies
      apt:
        pkg:
          - google-cloud-sdk-gke-gcloud-auth-plugin
          - kubectl
        state: present
      become: true
      become_user: root
    - name: Enable bash completion for kubectl
      shell:
        cmd: kubectl completion bash > /etc/bash_completion.d/kubectl
        creates: /etc/bash_completion.d/kubectl      
      become: true
      become_user: root        
    - name: Get cluster credentials
      shell: >
        gcloud container clusters get-credentials {{ cluster }} 
        --region {{ region }} 
        --project {{ project_id }} 
        --internal-ip     
    - name: Render templates
      template:
        src: "{{ item }}.j2"
        dest: "{{ item }}"
      delegate_to: localhost
      with_items:
        - ../bundle/app/images/video-download-api/job.yaml
        - ../bundle/app/images/video-downloader-creator/job.yaml
        - ../bundle/app/kustomization.yaml    
        - ../bundle/monitoring/kustomization.yaml   
        - ../bundle/kueue/kustomization.yaml                
    - name: Remove bundle locally
      local_action: 
        module: file 
        path: ../bundle.tar.gz 
        state: absent
    - name: Archive bundle locally
      archive:
        path: ../bundle
        dest: ../bundle.tar.gz
        exclusion_patterns:
          - "**/*.j2"
      delegate_to: localhost
    - name: Unarchive bundle remotely
      unarchive:
        src: ../bundle.tar.gz
        dest: ~/  
    - name: Enable scraping of kubelet and cAdvisor metrics
      shell: >
        kubectl patch operatorconfig config
        -n gmp-public
        --type=merge
        -p '{"collection":{"kubeletScraping":{"interval": "30s"}}}'               
    - name: Install monitoring tools
      shell: >
        kubectl apply -k .
      args:
        chdir: ~/bundle/monitoring
    - name: Install Kueue
      shell: >
        kubectl apply -k .
      args:
        chdir: ~/bundle/kueue
    - name: Build
      shell: >
        gcloud builds submit --tag {{ region }}-docker.pkg.dev/{{ project_id }}/registry/{{ item }}:latest
        --project {{ project_id }} {{ item }}
      with_items:
        - video-download-api
        - video-downloader-creator
        - video-downloader
      args:
        chdir: ~/bundle/app/images
    - name: Deploy app
      shell: >
        kubectl apply -k .
      args:
        chdir: ~/bundle/app